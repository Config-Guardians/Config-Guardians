services:
  hachiware:
    container_name: hachiware
    image: zachareee/hachiware
    build: ./hachiware
    ports:
      - 4000:4000
    environment:
      SIDECAR_HOST: steampipe:8080
      DATABASE_URL: postgres://postgres:postgres@hachiware-db:5432/postgres
      STEAMPIPE_DATABASE_URL: postgres://steampipe:password@steampipe:9193/steampipe
    depends_on:
      - steampipe
      - hachiware-db
    healthcheck:
      test: ["CMD-SHELL", "curl -s http://localhost:4000/api/swaggerui"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  steampipe:
    container_name: steampipe
    build: ./steampipe
    image: zachareee/steampipe-sidecar
    ports:
      - 8080:8080
      # - 9193:9193
  dashboard:
    container_name: dashboard
    build: ./dashboard
    develop:
      watch:
        - path: ./dashboard/app
          action: rebuild
    ports:
      - "3000:3000"
    environment:
      POSTGRES_URL: postgres://postgres:postgres@hachiware-db:5432/postgres
      HACHIWARE_URL: http://hachiware:4000/api
    depends_on:
      - hachiware-db
  hachiware-db:
    container_name: hachiware-db
    image: postgres:17.6
    environment:
      - POSTGRES_PASSWORD=postgres
  agent-system:
    container_name: agent-system
    platform: linux/amd64
    build: ./agent-system
    depends_on:
      hachiware:
        condition: service_healthy
    environment:
      OPENAI_API_KEY: ${OPENAI_API_KEY}
      HACHIWARE_ENDPOINT: http://hachiware:4000
      PYTHONUNBUFFERED: 1
      OLLAMA_HOST: 10.8.0.52:11434
